
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tensura RPG: Raphael OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;500;600;700&family=Noto+Serif+JP:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --bg-void: #000000;
            --raphael-cyan: #00f3ff;
            --raphael-white: #ffffff;
            --system-gold: #fcc200;
            --danger-red: #ff2a2a;
            --glass-panel: rgba(10, 15, 30, 0.85);
            
            --font-sage: 'Noto Serif JP', serif; /* Font giống hệt video */
            --font-tech: 'Orbitron', sans-serif;
            --font-ui: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

        body {
            background-color: var(--bg-void);
            /* Nền sao trôi như trong video */
            background-image: 
                radial-gradient(circle at center, rgba(0, 243, 255, 0.1) 0%, transparent 70%),
                url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2000&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #fff; font-family: var(--font-ui); height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Starfield Effect Layer */
        .starfield {
            position: fixed; inset: 0; pointer-events: none; z-index: -1;
            background: repeating-linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.02) 50%, transparent 100%);
            background-size: 100% 200%;
            animation: starsFall 10s linear infinite;
        }
        @keyframes starsFall { from { background-position: 0 0; } to { background-position: 0 200%; } }

        /* --- 2. NEW LOADING SCREEN (VIDEO ACCURATE: DIAMOND EVOLUTION) --- */
        #loading-overlay {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: none; align-items: center; justify-content: center;
            overflow: hidden; perspective: 1000px;
        }

        /* Hiệu ứng tia sáng nền */
        .burst-rays {
            position: absolute; width: 150vmax; height: 150vmax;
            background: repeating-conic-gradient(from 0deg, transparent 0deg, transparent 10deg, rgba(0, 243, 255, 0.05) 10deg, rgba(0, 243, 255, 0.1) 10.5deg);
            animation: spinSlow 60s linear infinite;
            opacity: 0.5;
        }

        /* Khối Kim Cương Trung Tâm (The Diamond) */
        .evolution-diamond {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
            transform: rotate(45deg); /* Xoay để thành hình thoi */
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3), inset 0 0 30px rgba(0, 243, 255, 0.3);
            animation: diamondPulse 2s ease-in-out infinite;
            background: rgba(0, 10, 20, 0.8);
            overflow: hidden;
        }

        /* Viền phụ bên trong kim cương */
        .evolution-diamond::before {
            content: ''; position: absolute; inset: 10px;
            border: 1px solid var(--raphael-cyan);
            box-shadow: 0 0 10px var(--raphael-cyan);
        }

        /* Text bên trong (Không xoay theo kim cương) */
        .diamond-content {
            transform: rotate(-45deg); /* Xoay ngược lại để chữ thẳng */
            text-align: center; color: #fff; z-index: 10;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }

        /* Chữ Kanji lớn (Giả lập) hoặc Tiếng Việt */
        .sage-title-main {
            font-family: var(--font-sage); font-size: 2.5em; font-weight: 900;
            line-height: 1; letter-spacing: -2px;
            text-shadow: 2px 2px 0px rgba(0, 243, 255, 0.5), -1px -1px 0px rgba(255,0,0,0.5); /* Glitch shadow */
            animation: textGlitch 3s infinite;
        }
        
        .sage-title-sub {
            font-family: var(--font-tech); font-size: 0.7em; letter-spacing: 3px;
            color: var(--raphael-cyan); text-transform: uppercase;
            border-top: 1px solid #fff; border-bottom: 1px solid #fff;
            padding: 2px 10px; margin-top: 5px;
        }

        /* Các vòng tròn xoay bên ngoài kim cương */
        .magic-ring {
            position: absolute; border-radius: 50%;
            border: 1px solid rgba(0, 243, 255, 0.3);
            box-shadow: 0 0 10px var(--raphael-cyan);
        }
        .mr-1 { width: 500px; height: 500px; border-top: 2px solid #fff; animation: spin 5s linear infinite; }
        .mr-2 { width: 600px; height: 600px; border: 1px dashed rgba(255,255,255,0.5); animation: spin 15s linear reverse infinite; }

        @keyframes spinSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes diamondPulse { 
            0%, 100% { box-shadow: 0 0 30px rgba(0, 243, 255, 0.3), inset 0 0 30px rgba(0, 243, 255, 0.3); border-color: rgba(255,255,255,0.8); } 
            50% { box-shadow: 0 0 60px rgba(0, 243, 255, 0.6), inset 0 0 60px rgba(0, 243, 255, 0.6); border-color: #fff; } 
        }
        @keyframes textGlitch {
            0% { transform: translate(0); }
            2% { transform: translate(-2px, 2px); }
            4% { transform: translate(2px, -2px); }
            6% { transform: translate(0); }
            100% { transform: translate(0); }
        }


        /* --- 3. NOTIFICATION SYSTEM (VIDEO ACCURATE: GOLDEN BANNER) --- */
        #notification-zone {
            position: fixed; top: 15%; right: 0; left: 0;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            z-index: 20000; pointer-events: none;
        }

        .raphael-toast {
            position: relative;
            /* Gradient đen vàng sang trọng */
            background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(20, 15, 5, 0.95) 20%, rgba(20, 15, 5, 0.95) 80%, rgba(0,0,0,0) 100%);
            border-top: 1px solid var(--system-gold);
            border-bottom: 1px solid var(--system-gold);
            padding: 15px 50px; min-width: 600px; text-align: center;
            pointer-events: auto;
            animation: toastEnter 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
            display: flex; align-items: center; justify-content: center; gap: 20px;
        }

        /* 2 Icon kim cương 2 bên */
        .toast-diamond {
            width: 12px; height: 12px; background: var(--system-gold);
            transform: rotate(45deg); box-shadow: 0 0 10px var(--system-gold);
        }

        .toast-content { display: flex; flex-direction: column; align-items: center; }
        
        .toast-header {
            font-family: var(--font-tech); font-size: 0.8em; color: var(--system-gold);
            letter-spacing: 4px; text-transform: uppercase; margin-bottom: 5px;
            text-shadow: 0 0 5px var(--system-gold);
        }
        
        .toast-msg {
            font-family: var(--font-sage); font-weight: 700; font-size: 1.2em; color: #fff;
            text-shadow: 0 2px 2px #000;
        }

        /* Dòng kẻ sáng chạy qua khi xuất hiện */
        .raphael-toast::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
            transform: translateX(-100%);
            animation: shineSwipe 0.8s ease-out forwards;
        }

        @keyframes toastEnter { 
            0% { transform: scaleY(0); opacity: 0; } 
            100% { transform: scaleY(1); opacity: 1; } 
        }
        @keyframes shineSwipe { 
            0% { transform: translateX(-100%); } 
            100% { transform: translateX(100%); } 
        }
        @keyframes toastExit { 
            to { transform: scaleY(0); opacity: 0; } 
        }


        /* --- 4. UI SCREENS (LOGIN / CHAR / MAIN) --- */
        .overlay-screen {
            position: fixed; inset: 0; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            background: rgba(2, 4, 8, 0.95); backdrop-filter: blur(10px);
            transition: opacity 0.5s ease;
        }

        .raphael-panel {
            width: 700px; background: rgba(5, 10, 20, 0.9);
            border: 1px solid var(--raphael-cyan);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
            position: relative; overflow: hidden;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        
        .panel-inner { padding: 40px; display: flex; flex-direction: column; gap: 20px; }

        .panel-title {
            font-family: var(--font-tech); font-size: 2.5em; color: var(--raphael-cyan);
            text-align: center; letter-spacing: 5px; text-shadow: 0 0 15px var(--raphael-cyan);
            margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;
        }

        .rp-input, .rp-select, .rp-textarea {
            width: 100%; background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px; color: #fff; font-family: var(--font-ui); font-size: 1.1em;
            outline: none; transition: 0.3s;
        }
        .rp-textarea { height: 80px; resize: none; }
        .rp-input:focus, .rp-select:focus {
            border-color: var(--raphael-cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            background: rgba(0, 243, 255, 0.05);
        }
        .rp-select option { background: #000; }

        .rp-btn {
            width: 100%; padding: 15px; background: transparent;
            border: 1px solid var(--raphael-cyan); color: var(--raphael-cyan);
            font-family: var(--font-tech); font-weight: 700; font-size: 1.1em; letter-spacing: 3px;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .rp-btn:hover { background: var(--raphael-cyan); color: #000; box-shadow: 0 0 40px var(--raphael-cyan); }

        .hidden { display: none !important; }

        /* Main Game UI */
        #game-interface {
            width: 95%; max-width: 1400px; height: 95vh;
            display: grid; grid-template-columns: 280px 1fr 320px;
            opacity: 0; transition: opacity 1s;
            background: var(--glass-panel); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px; box-shadow: 0 0 80px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }

        /* Sidebar */
        .sidebar { padding: 30px; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 15px; }
        .side-btn {
            background: rgba(255,255,255,0.03); padding: 15px; color: #aaa; cursor: pointer; 
            font-family: var(--font-tech); font-size: 0.8em; display: flex; align-items: center; gap: 15px;
            transition: 0.3s; border-left: 2px solid transparent;
        }
        .side-btn:hover { border-color: var(--raphael-cyan); color: #fff; background: rgba(0, 243, 255, 0.05); text-shadow: 0 0 5px var(--raphael-cyan); }
        .quick-slots { margin-top: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .q-slot {
            aspect-ratio: 1; border: 1px dashed #444; display: flex; align-items: center; justify-content: center;
            font-size: 0.9em; color: #555; cursor: pointer; transition: 0.2s;
        }
        .q-slot:hover { border-color: var(--raphael-cyan); color: var(--raphael-cyan); }

        /* Chat */
        .main-chat { position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #chat-scroll {
            flex: 1; padding: 40px 10%; overflow-y: auto; scroll-behavior: smooth;
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        #chat-scroll::-webkit-scrollbar { width: 5px; }
        #chat-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .msg { margin-bottom: 35px; animation: fadeInUp 0.5s ease; position: relative; }
        .msg-narrative { font-size: 1.15em; line-height: 1.8; color: #dcdcdc; text-align: justify; }
        .msg-narrative b { color: var(--raphael-cyan); font-weight: 600; text-shadow: 0 0 5px rgba(0,243,255,0.5); }
        .msg-dialogue {
            font-size: 1.2em; color: #fff; border-left: 3px solid var(--raphael-cyan);
            padding-left: 20px; margin: 15px 0; font-style: italic; background: linear-gradient(90deg, rgba(0,243,255,0.05), transparent);
        }
        .msg-system {
            text-align: center; font-family: var(--font-tech); font-size: 0.85em; color: var(--system-gold);
            border-top: 1px solid rgba(255, 215, 0, 0.3); border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding: 15px 0; margin: 30px 0; letter-spacing: 3px; background: rgba(255,215,0,0.03);
        }
        .msg-player {
            text-align: right; font-family: var(--font-tech); color: var(--raphael-cyan);
            font-size: 1.1em; margin-top: 10px; border-right: 2px solid var(--raphael-cyan); padding-right: 15px; opacity: 0.9;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Input */
        .input-bar {
            padding: 30px 50px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; gap: 20px; align-items: center;
        }
        #user-input {
            flex: 1; background: transparent; border: none; color: #fff;
            font-family: var(--font-ui); font-size: 1.3em; outline: none; font-weight: 600;
        }
        #send-btn { color: var(--raphael-cyan); cursor: pointer; transition: 0.3s; font-size: 1.4em; }

        /* Status */
        .status-panel { padding: 30px; border-left: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 25px; }
        .char-head { text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px; }
        .char-name { font-family: var(--font-tech); font-size: 1.8em; color: #fff; letter-spacing: 3px; text-shadow: 0 0 10px var(--raphael-cyan); }
        .char-race { color: #888; font-size: 0.9em; letter-spacing: 2px; margin-top: 5px; }
        .bar-wrap { margin-bottom: 5px; }
        .bar-lbl { display: flex; justify-content: space-between; font-size: 0.8em; color: #aaa; margin-bottom: 3px; font-family: var(--font-tech); }
        .bar-track { height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .bar-val { height: 100%; transition: width 0.5s; border-radius: 3px; box-shadow: 0 0 10px currentColor; }
        .ai-state {
            margin-top: auto; padding: 20px; background: rgba(0, 243, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.1); text-align: center; font-family: var(--font-tech);
            font-size: 0.8em; color: var(--raphael-cyan); letter-spacing: 3px; animation: blink 2s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <div id="notification-zone"></div>

    <div id="loading-overlay">
        <div class="starfield"></div>
        <div class="burst-rays"></div>
        <div class="magic-ring mr-1"></div>
        <div class="magic-ring mr-2"></div>
        
        <div class="evolution-diamond">
            <div class="diamond-content">
                <div class="sage-title-main">XÁC MINH</div>
                <div class="sage-title-main">DANH TÍNH</div>
                <div class="sage-title-sub" id="ai-status">ĐANG PHÂN TÍCH</div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="overlay-screen">
        <div class="raphael-panel">
            <div class="panel-inner">
                <div class="panel-title">RAPHAEL OS</div>
                <div style="display:flex; gap:20px;">
                    <button onclick="authMode='login'" class="rp-btn" style="margin:0; border-color:#444; color:#888;">ĐĂNG NHẬP</button>
                    <button onclick="authMode='register'" class="rp-btn" style="margin:0; border-color:#444; color:#888;">ĐĂNG KÝ</button>
                </div>
                <input type="text" id="auth-u" class="rp-input" placeholder="Tên đăng nhập (Identity Code)" style="margin-top:20px">
                <input type="password" id="auth-p" class="rp-input" placeholder="Mật khẩu (Access Key)" style="margin-top:10px">
                <button class="rp-btn" style="margin-top:35px;" onclick="CheckerBot.authenticate()">KẾT NỐI HỆ THỐNG</button>
                <div style="text-align:center; margin-top:20px; color:#666; cursor:pointer;" onclick="CheckerBot.guestLogin()">[ Truy cập chế độ Khách ]</div>
            </div>
        </div>
    </div>

    <div id="char-screen" class="overlay-screen hidden">
        <div class="raphael-panel" style="width: 800px;">
            <div class="panel-inner">
                <div class="panel-title">SOUL TRANSFER</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <input type="text" id="cc-name" class="rp-input" placeholder="Tên Định Danh (Name)">
                    <select id="cc-gender" class="rp-select rp-input"><option>Nam</option><option>Nữ</option><option>Vô tính</option></select>
                </div>
                <select id="cc-race" class="rp-select rp-input" style="margin-top:10px">
                    <option value="Slime">Slime (Chất nhờn)</option>
                    <option value="Human">Con Người</option>
                    <option value="Demon">Ác Ma</option>
                    <option value="Oni">Oni (Quỷ Nhân)</option>
                </select>
                <textarea id="cc-look" class="rp-textarea" placeholder="Mô tả ngoại hình..." style="margin-top:10px"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:10px;">
                    <input type="text" id="cc-reason" class="rp-input" placeholder="Nguyên nhân tử vong">
                    <input type="text" id="cc-loc" class="rp-input" placeholder="Nơi chuyển sinh">
                </div>
                <button class="rp-btn" style="margin-top:40px;" onclick="CheckerBot.createChar()">TIẾN HÀNH CHUYỂN SINH</button>
            </div>
        </div>
    </div>

    <div id="game-interface">
        <div class="sidebar">
            <div class="side-btn" onclick="MainBot.toggleModal('inventory-modal', true)"><i class="fa-solid fa-box-open"></i> TÚI ĐỒ</div>
            <div class="side-btn" onclick="MainBot.toggleModal('skills-modal', true)"><i class="fa-solid fa-bolt"></i> KỸ NĂNG</div>
            <div class="side-btn" onclick="MainBot.notify('Trạng thái ổn định', 'info')"><i class="fa-solid fa-address-card"></i> TRẠNG THÁI</div>
            <div style="margin-top:auto;"></div>
            <div class="side-btn" style="border-color:var(--danger-red); color:var(--danger-red);" onclick="CheckerBot.logout()"><i class="fa-solid fa-power-off"></i> NGẮT KẾT NỐI</div>
            <div class="quick-slots" id="quick-slots-container">
                <div class="q-slot" onclick="CheckerBot.activateSkill(0)"></div>
                <div class="q-slot" onclick="CheckerBot.activateSkill(1)"></div>
                <div class="q-slot" onclick="CheckerBot.activateSkill(2)"></div>
                <div class="q-slot" onclick="CheckerBot.activateSkill(3)"></div>
            </div>
        </div>
        <div class="main-chat">
            <div id="chat-scroll"><div class="msg msg-system">KẾT NỐI VỚI GIỌNG NÓI THẾ GIỚI THÀNH CÔNG.</div></div>
            <div class="input-bar">
                <span style="color:var(--raphael-cyan); font-family:var(--font-tech)">>></span>
                <input type="text" id="user-input" placeholder="Nhập hành động..." autocomplete="off">
                <i class="fa-solid fa-paper-plane" id="send-btn" onclick="CheckerBot.process()"></i>
            </div>
        </div>
        <div class="status-panel">
            <div class="char-head">
                <div class="char-name" id="hud-name">UNKNOWN</div>
                <div class="char-race" id="hud-race">SOUL FORM</div>
            </div>
            <div class="bar-wrap">
                <div class="bar-lbl"><span>HP (SINH LỰC)</span><span id="hud-hp">100/100</span></div>
                <div class="bar-track"><div id="bar-hp" class="bar-val" style="width:100%; background:var(--danger-red); box-shadow:0 0 10px var(--danger-red);"></div></div>
            </div>
            <div class="bar-wrap">
                <div class="bar-lbl"><span>MP (MA TỐ)</span><span id="hud-mp">100/100</span></div>
                <div class="bar-track"><div id="bar-mp" class="bar-val" style="width:100%; background:var(--raphael-cyan); box-shadow:0 0 10px var(--raphael-cyan);"></div></div>
            </div>
            <div class="ai-state" id="ai-status-txt">SYSTEM IDLE</div>
        </div>
    </div>

    <div id="inventory-modal" class="modal-overlay" style="display:none;"><div style="color:#fff">Inventory...</div></div>
    <div id="skills-modal" class="modal-overlay" style="display:none;"><div style="color:#fff">Skills...</div></div>

    <script>
        // --- CẤU HÌNH ---
        const WORKER_URL = "https://tyn-cdy.pages.dev/"; // <--- THAY WORKER URL
        const MODEL_ID = "gpt-oss-120b";
        const ADMIN = { u: "tkfey", p: "12345678900" };

        let state = {
            player: { 
                name: "", race: "", gender: "", appearance: "", reason: "", location: "", 
                hp: 100, maxHp: 100, mana: 100, manaCap: 100, 
                skills: [], inventory: [], equipped: [null, null, null, null] 
            },
            history: [],
            isDead: false
        };
        let currentUser = null;
        let authMode = 'login';

        // 1. PROVIDER BOT
        class ProviderBot {
            static getWorldContext(p) {
                return `[HỆ THỐNG TENSURA]
                - Vị trí: ${p.location}.
                - Tình trạng: ${p.race}, HP:${p.hp}/${p.maxHp}.
                - Ngoại hình: ${p.appearance}.
                - Kỹ năng: ${p.skills.join(", ") || "Không"}.
                - Túi đồ: ${p.inventory.map(i=>i.name).join(", ") || "Trống"}.
                `;
            }
        }

        // 2. CHECKER BOT
        class CheckerBot {
            static async process() {
                const input = document.getElementById('user-input').value.trim();
                if(!input) return;
                
                if(this.detectCheat(input)) {
                    MainBot.print(input, 'player');
                    document.getElementById('user-input').value = '';
                    MainBot.notify("CẢNH BÁO: Can thiệp trái phép bị từ chối.", "error");
                    return;
                }

                if(input === ADMIN.u) {
                    state.player.hp = 99999; state.player.mana = 99999;
                    MainBot.notify("Quyền Quản Trị Viên: Kích hoạt", "skill");
                    document.getElementById('user-input').value = '';
                    return;
                }

                MainBot.print(input, 'player');
                document.getElementById('user-input').value = '';
                
                const context = ProviderBot.getWorldContext(state.player);
                const sysPrompt = `Bạn là Raphael (Đại Hiền Giả). Player: ${state.player.name} (${state.player.race}). 
                Style: Light Novel, chi tiết. KHÔNG tạo lựa chọn A/B/C.
                Context: ${context}.
                Quy tắc phản hồi dữ liệu ngầm (bắt buộc ở cuối nếu có thay đổi):
                /// DATA: {"hp_diff": -10, "mp_diff": -5, "add_item": "Potion", "add_skill": "Fireball"} ///`;

                MainBot.loading(true);
                try {
                    const response = await this.callWorker(sysPrompt, input);
                    const cleanText = response.replace(/\/\/\/ DATA: .*? \/\/\//, '');
                    MainBot.print(cleanText, 'narrative');
                    this.parseData(response);
                } catch (e) {
                    MainBot.notify("Mất kết nối với Giọng Nói Thế Giới", "error");
                    console.error(e);
                }
                MainBot.loading(false);
            }

            static detectCheat(text) { return /(tôi|mình)\s*(nhận|lấy|có)\s*(được)?\s*(skill|kỹ năng|sức mạnh)/i.test(text); }

            static async callWorker(sys, user) {
                const payload = {
                    model: MODEL_ID,
                    messages: [{ role: "system", content: sys }, ...state.history, { role: "user", content: user }],
                    stream: false
                };
                const res = await fetch(`${WORKER_URL}/v1/chat/completions`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                return data.choices[0].message.content;
            }

            static parseData(text) {
                const match = text.match(/\/\/\/ DATA: (.*?) \/\/\//);
                if(match) {
                    try {
                        const data = JSON.parse(match[1]);
                        if(data.hp_diff) state.player.hp = Math.max(0, Math.min(state.player.maxHp, state.player.hp + data.hp_diff));
                        if(data.mp_diff) state.player.mana = Math.max(0, Math.min(state.player.manaCap, state.player.mana + data.mp_diff));
                        if(data.add_item) {
                            const exists = state.player.inventory.find(i => i.name === data.add_item);
                            if(exists) exists.qty++; else state.player.inventory.push({name: data.add_item, qty: 1});
                            MainBot.notify(`Nhận vật phẩm: ${data.add_item}`, "info");
                        }
                        if(data.add_skill && !state.player.skills.includes(data.add_skill)) {
                            state.player.skills.push(data.add_skill);
                            MainBot.notify(`Thẩm định kỹ năng mới: ${data.add_skill}`, "skill");
                        }
                        MainBot.updateHUD();
                    } catch(e) {}
                }
            }

            static activateSkill(slotIdx) {
                const skill = state.player.equipped[slotIdx];
                if(skill) this.processInput(`[ACTION] Kích hoạt kỹ năng: ${skill}`);
            }
            static processInput(text) { document.getElementById('user-input').value = text; this.process(); }
            
            static authenticate() {
                const u = document.getElementById('auth-u').value.trim();
                const p = document.getElementById('auth-p').value.trim();
                if(!u || !p) return MainBot.notify("Thiếu thông tin", "error");
                if(u===ADMIN.u && p===ADMIN.p) { currentUser="ADMIN"; state.player.hp=99999; this.enterGame(); return; }
                const db = JSON.parse(localStorage.getItem('tensura_users') || '{}');
                if(authMode === 'register') {
                    if(db[u]) return MainBot.notify("Tên đã tồn tại", "error");
                    db[u] = { pass: p }; localStorage.setItem('tensura_users', JSON.stringify(db));
                    MainBot.notify("Đăng ký thành công", "info");
                } else {
                    if(!db[u] || db[u].pass !== p) return MainBot.notify("Sai thông tin", "error");
                    currentUser = u;
                    const d = localStorage.getItem(`tensura_save_${u}`);
                    if(d) { state = JSON.parse(d); this.enterGame(); } else this.showChar();
                }
            }
            static guestLogin() { currentUser=null; this.showChar(); }
            static showChar() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('char-screen').classList.remove('hidden'); }
            static createChar() {
                state.player.name = document.getElementById('cc-name').value || "Rimuru";
                state.player.race = document.getElementById('cc-race').value;
                state.player.gender = document.getElementById('cc-gender').value;
                state.player.appearance = document.getElementById('cc-look').value;
                state.player.reason = document.getElementById('cc-reason').value;
                state.player.location = document.getElementById('cc-loc').value || "Hang Động";
                
                document.getElementById('char-screen').classList.add('hidden');
                MainBot.loading(true);
                
                setTimeout(() => {
                    this.enterGame();
                    this.processInput(`KHỞI ĐẦU: Tên: ${state.player.name}, Tộc: ${state.player.race}, Ngoại hình: ${state.player.appearance}. Lý do chết: ${state.player.reason}. Nơi đến: ${state.player.location}. Mô tả khởi đầu.`);
                }, 3000);
            }
            static enterGame() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('char-screen').classList.add('hidden');
                document.getElementById('game-interface').style.opacity = 1;
                MainBot.updateHUD();
            }
            static logout() { if(currentUser) localStorage.setItem(`tensura_save_${currentUser}`, JSON.stringify(state)); location.reload(); }
        }

        // 3. MAIN BOT (UI)
        class MainBot {
            static notify(msg, type='info') {
                const zone = document.getElementById('notification-zone');
                const el = document.createElement('div');
                el.className = 'sage-notice';
                let title = "THÔNG BÁO HỆ THỐNG";
                if(type === 'skill') title = "THẨM ĐỊNH KỸ NĂNG";
                if(type === 'error') title = "CẢNH BÁO";
                
                el.innerHTML = `
                    <div class="toast-diamond"></div>
                    <div class="toast-content">
                        <div class="toast-header">${title}</div>
                        <div class="toast-msg">${msg}</div>
                    </div>
                    <div class="toast-diamond"></div>
                `;
                zone.appendChild(el);
                setTimeout(() => { el.style.animation='toastExit 0.5s forwards'; setTimeout(()=>el.remove(), 500); }, 4000);
            }
            static loading(on) {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = on ? 'flex' : 'none';
                if(on) {
                    document.getElementById('ai-status').innerText = "ĐANG PHÂN TÍCH...";
                    document.getElementById('ai-status-txt').innerText = "CALCULATING...";
                    document.getElementById('ai-status-txt').style.color = "var(--system-gold)";
                } else {
                    document.getElementById('ai-status-txt').innerText = "SYSTEM IDLE";
                    document.getElementById('ai-status-txt').style.color = "var(--raphael-cyan)";
                }
            }
            static print(text, type='narrative') {
                const scroll = document.getElementById('chat-scroll');
                const div = document.createElement('div');
                div.className = `msg msg-${type}`;
                div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                scroll.appendChild(div);
                scroll.scrollTop = scroll.scrollHeight;
                state.history.push({role: type==='player'?'user':'assistant', content: text});
                if(state.history.length > 20) state.history.shift();
                if(currentUser && type==='narrative') localStorage.setItem(`tensura_save_${currentUser}`, JSON.stringify(state));
            }
            static updateHUD() {
                const p = state.player;
                document.getElementById('hud-name').innerText = p.name.toUpperCase();
                document.getElementById('hud-race').innerText = p.race.toUpperCase();
                document.getElementById('hud-hp').innerText = `${Math.floor(p.hp)}/${p.maxHp}`;
                document.getElementById('bar-hp').style.width = `${Math.max(0,(p.hp/p.maxHp)*100)}%`;
                document.getElementById('hud-mp').innerText = `${Math.floor(p.mana)}/${p.manaCap}`;
                document.getElementById('bar-mp').style.width = `${Math.max(0,(p.mana/p.manaCap)*100)}%`;
            }
            static toggleModal(id, show) {
                document.getElementById(id).style.display = show ? 'flex' : 'none';
            }
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') CheckerBot.process(); });
    </script>
</body>
</html>
